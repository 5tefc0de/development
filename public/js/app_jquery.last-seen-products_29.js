;(function($){var emptyObj={};$.plugin('swLastSeenProducts',{defaults:{productLimit:20,baseUrl:'/',shopId:1,currentArticle:emptyObj,listSelector:'.last-seen-products--slider',containerSelector:'.last-seen-products--container',itemCls:'last-seen-products--item product-slider--item product--box box--slider',titleCls:'last-seen-products-item--title product--title',imageCls:'last-seen-products-item--image product--image',noPicture:''},init:function(){var me=this;me.applyDataAttributes();me.$list=me.$el.find(me.opts.listSelector);me.$container=me.$list.find(me.opts.containerSelector);me.productSlider=me.$list.data('plugin_swProductSlider');if(!me.productSlider){return;}
me.storage=StorageManager.getLocalStorage();if($('body').hasClass('is--ctl-detail')){me.collectProduct(me.opts.currentArticle);$.subscribe(me.getEventName('plugin/swAjaxVariant/onRequestData'),$.proxy(me.onAjaxVariantChange,me));}
me.createProductList();},onAjaxVariantChange:function(){var me=this;me.collectProduct(window.lastSeenProductsConfig.currentArticle);me.clearProductList();me.createProductList();},clearProductList:function(){var me=this;me.$container.children().remove();},createProductList:function(){var me=this,opts=me.opts,itemKey='lastSeenProducts-'+opts.shopId+'-'+opts.baseUrl,productsJson=me.storage.getItem(itemKey),products=productsJson?JSON.parse(productsJson):[],len=Math.min(opts.productLimit,products.length);if(len>0){me.$el.removeClass('is--hidden');}
$.each(products,function(i,product){if(product.articleId===opts.currentArticle.articleId){return;}
me.$container.append(me.createTemplate(product));});me.productSlider.initSlider();$.publish('plugin/swLastSeenProducts/onCreateProductList',[me]);},createTemplate:function(article){var me=this,$template=$('<div>',{'class':me.opts.itemCls,'html':[me.createProductImage(article),me.createProductTitle(article)]});$.publish('plugin/swLastSeenProducts/onCreateTemplate',[me,$template,article]);return $template;},createProductTitle:function(data){var me=this,$title=$('<a>',{'rel':'nofollow','class':me.opts.titleCls,'title':data.articleName,'href':data.linkDetailsRewritten,'html':data.articleName});$.publish('plugin/swLastSeenProducts/onCreateProductTitle',[me,$title,data]);return $title;},createProductImage:function(data){var me=this,image=data.images[0],element,imageEl,imageMedia,srcSet;element=$('<a>',{'class':me.opts.imageCls,'href':data.linkDetailsRewritten,'title':data.articleName});imageEl=$('<span>',{'class':'image--element'}).appendTo(element);imageMedia=$('<span>',{'class':'image--media'}).appendTo(imageEl);if(image){srcSet=image.sourceSet;}else{srcSet=me.opts.noPicture;}
$('<img>',{'srcset':srcSet,'alt':data.articleName,'title':data.articleName}).appendTo(imageMedia);$.publish('plugin/swLastSeenProducts/onCreateProductImage',[me,element,data]);return element;},collectProduct:function(newProduct){var me=this,opts=me.opts,itemKey='lastSeenProducts-'+opts.shopId+'-'+opts.baseUrl,productsJson=me.storage.getItem(itemKey),products=productsJson?$.parseJSON(productsJson):[],linkDetailsQuery='',len=products.length,i=0,url,urlQuery;if(!newProduct||$.isEmptyObject(newProduct)){return;}
for(;i<len;i++){if(products[i]&&products[i].articleId===newProduct.articleId){products.splice(i,1);}}
url=newProduct.linkDetailsRewritten;urlQuery=me.extractQueryParameters(url);delete urlQuery.c;if($.param(urlQuery)){linkDetailsQuery=$.param(urlQuery);linkDetailsQuery='?'+linkDetailsQuery;}
if(url.indexOf('/sCategory')!==-1){newProduct.linkDetailsRewritten=url.replace(/\/?sCategory\/[0-9]+/i,'');}else if(url.indexOf('?')!==-1){newProduct.linkDetailsRewritten=url.substring(0,url.indexOf('?'))+linkDetailsQuery;}
products.splice(0,0,newProduct);while(products.length>opts.productLimit+1){products.pop();}
me.storage.setItem(itemKey,JSON.stringify(products));$.publish('plugin/swLastSeenProducts/onCollectProduct',[me,newProduct]);},extractQueryParameters:function(url){var queryParams={};if(url.indexOf('?')===-1){return{};}
url=url.substring(url.indexOf('?'));url=url.substring(1);$.each(url.split('&'),function(key,param){param=param.split('=');param[0]=decodeURIComponent(param[0]);param[1]=decodeURIComponent(param[1]);if(param[0].length&&param[1].length&&!queryParams.hasOwnProperty(param[0])){queryParams[param[0]]=param[1];}});return queryParams;}});}(jQuery));